name: Deploy To EC2 (Compose)

on:
  push:
    branches: [ "main", "DEOK-50-ì¢‹ì•„ìš”-ì¡°íšŒìˆ˜-êµ¬í˜„" ]

  workflow_dispatch:

env:
  AWS_REGION: ap-northeast-2
  AWS_SECURITY_GROUP_ID: ${{ secrets.AWS_SECURITY_GROUP_ID }}

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      # Default Setup
      - name: Github Repository File Checkout
        uses: actions/checkout@v4

      # Get Github Action Public IP
      - name: Get Github Action Public IP
        id: ip
        uses: haythem/public-ip@v1.2

      # Setup AWS credentials
      - name: Setup AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      # Inbound IP whitelistì— GitHub Runner IP ì„ì‹œ ë“±ë¡
      - name: Authorize GitHub Action IP to EC2 SG
        run: |
          echo "ğŸŸ¢ Authorize IP"
          aws ec2 authorize-security-group-ingress \
            --group-id ${{ env.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port ${{ secrets.EC2_SSH_PORT }} \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32
      # ------------------------------------------------------

      # For Java Build
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: 'gradle' # Gradle ìºì‹œ ìë™ í™œì„±í™” (ë¹Œë“œ ì†ë„ ë†’ì´ê¸°)

      # For Build File Creation
      - name: Create application.yml
        run: echo '${{ secrets.APPLICATION_YML }}' > ./src/main/resources/application.yml

      - name: Create .env for Docker Compose
        run: echo '${{ secrets.DOCKER_COMPOSE_ENV }}' > .env

      # Build
      - name: Build JAR
        run: ./gradlew clean build -x test

      - name: Modify Jar File Name & Path
        run: mv ./build/libs/*SNAPSHOT.jar ./deokive.jar

      # Assemble deployment files
      - name: Collect deployment files
        run: |
          mkdir deploy
          mv deokive.jar deploy/
          cp docker-compose.yml deploy/
          mv .env deploy/

      # SCP to EC2 : Transfer Build File
      - name: Transfer All Files to EC2 Using SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          port: ${{ secrets.EC2_SSH_PORT }} # ì›¹ë´‡ ìë™ ê³µê²©ëŸ‰ ê°ì•ˆí•˜ì—¬ ê¸°ë³¸ 22ë²ˆ í¬íŠ¸ê°€ ì•„ë‹Œ ë‹¤ë¥¸ í¬íŠ¸ ì‚¬ìš©
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: deploy/*
          target: /home/${{ secrets.EC2_USERNAME }}/deokive/tobe # íŒŒì¼ ì €ì¥ë  ê²½ë¡œ ì„¤ì •
          strip_components: 1 # deploy í´ë” ê»ë°ê¸°ëŠ” ë²—ê¸°ê³  ë‚´ìš©ë¬¼ë§Œ ì „ì†¡

      # SSH Known Hosts Setup in GitHub Actions Runner
      - name: Add EC2 host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H -p ${{ secrets.EC2_SSH_PORT }} ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # [1]. ë°°í¬ ë””ë ‰í† ë¦¬ ìƒì„± (ì„œë²„ì— ì´ë¯¸ ìˆë‹¤ë©´ ìƒëµ)
      - name: Deploy via SSH (docker compose pull & up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          port: ${{ secrets.EC2_SSH_PORT }} # ì›¹ë´‡ ìë™ ê³µê²©ëŸ‰ ê°ì•ˆí•˜ì—¬ ê¸°ë³¸ 22ë²ˆ í¬íŠ¸ê°€ ì•„ë‹Œ ë‹¤ë¥¸ í¬íŠ¸ ì‚¬ìš©
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e # ì—ëŸ¬ ë°œìƒ ì‹œ ìŠ¤í¬ë¦½íŠ¸ ì¤‘ë‹¨
            
            echo "ğŸ’¡ Step 1. ì‹¤í–‰ ì „ ì¤€ë¹„"
            
            echo "ğŸŸ¢ ì§„í–‰ì¤‘ì´ë˜ ë¹Œë“œ ê²½ë¡œ ì œê±°"
            rm -rf $HOME/deokive/app || true
            
            echo "ğŸŸ¢ Deploy ë””ë ‰í† ë¦¬ì—ì„œ íŒŒì¼ë“¤ì„ ê°ì ìœ„ì¹˜ë¡œ ì´ë™"
            mkdir -p $HOME/deokive/app
            mv $HOME/deokive/tobe/deokive.jar $HOME/deokive/app/deokive.jar
            
            mkdir -p $HOME/deokive/infra
            mv $HOME/deokive/tobe/docker-compose.yml $HOME/deokive/infra/docker-compose.yml
            mv $HOME/deokive/tobe/.env $HOME/deokive/infra/.env
            
            # -------------------------------------- #
            
            echo "ğŸ’¡ Step 2-1. ì‹¤í–‰ : Docker"
            echo "ğŸŸ¢ Docker Compose ë¹Œë“œ ì‹œì‘"
            cd $HOME/deokive/infra
            set -a 
            source .env 
            set +a
            docker compose up -d
            
            echo "ğŸŸ¢ Docker Compose ìƒíƒœ í™•ì¸"
            docker compose ps
            
            echo "ğŸŸ¢ DB, Redis Test"
            sleep 5
            # Redis í…ŒìŠ¤íŠ¸
            echo "ğŸŸ¢ Redis Ping Test"
            docker exec redis-container redis-cli -a $REDIS_PASSWORD ping
            
            # MySQL í…ŒìŠ¤íŠ¸
            echo "ğŸŸ¢ MySQL Ping Test"
            docker exec -e MYSQL_PWD=$DB_PASSWORD mysql-container mysqladmin ping -h localhost -uroot
            
            # RabbitMQ í…ŒìŠ¤íŠ¸
            echo "ğŸŸ¢ RabbitMQ Ping Test"
            docker exec rabbitmq-container rabbitmq-diagnostics -q ping
            
            echo "ğŸ’¡ Step 2-2. ì‹¤í–‰ : Spring Boot"
            echo "ğŸŸ¢ Spring Boot ì‹¤í–‰"
            echo "ğŸŸ¢ deokive.service ì¬ì‹œì‘"
            sudo systemctl restart deokive.service
            
            echo "ğŸŸ¢ Spring Boot Health Check (ìµœëŒ€ 100ì´ˆ ëŒ€ê¸°)"
            for i in {1..20}; do
              if curl -fs http://localhost:8080/api/system/health > /dev/null; then
                echo "âœ… Health check ì„±ê³µ! ë°°í¬ ì™„ë£Œ."
            
                # âœ… (ì„±ê³µ ì‹œ) 'tobe' ë””ë ‰í† ë¦¬ ìµœì¢… ì œê±°
                cd $HOME # infra ë””ë ‰í† ë¦¬ì—ì„œ ë‚˜ì˜´
                rm -rf $HOME/deokive/tobe
            
                exit 0 # ìŠ¤í¬ë¦½íŠ¸ ì„±ê³µ ì¢…ë£Œ
              fi
              echo "($i/20) Spring Boot ì‹œì‘ ëŒ€ê¸° ì¤‘... (5ì´ˆ í›„ ì¬ì‹œë„)"
              sleep 5
            done
            
            echo "âŒ Health check ì‹¤íŒ¨. ë°°í¬ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì¤‘ë‹¨í•©ë‹ˆë‹¤."
            echo "EC2 ì„œë²„ì—ì„œ 'sudo journalctl -f -u deokive.service' ëª…ë ¹ì–´ë¡œ ë¡œê·¸ë¥¼ í™•ì¸í•˜ì„¸ìš”."
            
            # âŒ (ì‹¤íŒ¨ ì‹œ) 'tobe' ë””ë ‰í† ë¦¬ ìµœì¢… ì œê±°
            cd $HOME # infra ë””ë ‰í† ë¦¬ì—ì„œ ë‚˜ì˜´
            rm -rf $HOME/deokive/tobe
            
            exit 1

      # IP ì œê±° (ë³´ì•ˆê·¸ë£¹ì—ì„œ ì¦‰ì‹œ ì‚­ì œ)
      - name: Remove IP from Security Group
        if: always() # ì‹¤íŒ¨í•´ë„ ë°˜ë“œì‹œ ì§€ì›€
        run: |
          echo "ğŸ”¥ Revoke IP: ${{ steps.ip.outputs.ipv4 }}"
          aws ec2 revoke-security-group-ingress \
            --group-id ${{ env.AWS_SECURITY_GROUP_ID }} \
            --protocol tcp \
            --port ${{ secrets.EC2_SSH_PORT }} \
            --cidr ${{ steps.ip.outputs.ipv4 }}/32