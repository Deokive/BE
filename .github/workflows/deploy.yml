name: Deploy To EC2 (Compose)

on:
  push:
    branches: [ "main", "cicd-test" ]

env:
  AWS_REGION: ap-northeast-2

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:

      # Default Setup
      - name: Github Repository File Checkout
        uses: actions/checkout@v4

      # For Java Build
      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 21
          cache: 'gradle' # Gradle 캐시 자동 활성화 (빌드 속도 높이기)

      # For Build File Creation
      - name: Create application.yml
        run: echo "${{ secrets.APPLICATION_YML }}" > ./src/main/resources/application.yml

      - name: Create .env for Docker Compose
        run: echo "${{ secrets.DOCKER_COMPOSE_ENV }}" > .env

      # Build
      - name: Build JAR
        run: ./gradlew clean build -x test

      - name: Modify Jar File Name & Path
        run: mv ./build/libs/*SNAPSHOT.jar ./deokive.jar

      # Assemble deployment files
      - name: Collect deployment files
        run: |
          mkdir deploy
          mv deokive.jar deploy/
          cp docker-compose.yml deploy/
          mv .env deploy/

      # SCP to EC2 : Transfer Build File
      - name: Transfer All Files to EC2 Using SCP
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          source: deploy/*
          target: /home/${{ secrets.EC2_USERNAME }}/deokive/tobe # 파일 저장될 경로 설정
          strip_components: 1 # deploy 폴더 껍데기는 벗기고 내용물만 전송

      # SSH Known Hosts Setup in GitHub Actions Runner
      - name: Add EC2 host to known_hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H ${{ secrets.EC2_HOST }} >> ~/.ssh/known_hosts

      # [1]. 배포 디렉토리 생성 (서버에 이미 있다면 생략)
      - name: Deploy via SSH (docker compose pull & up)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_HOST }}
          username: ${{ secrets.EC2_USERNAME }}
          key: ${{ secrets.EC2_PRIVATE_KEY }}
          script_stop: true
          script: |
            set -e # 에러 발생 시 스크립트 중단
            
            echo "💡 Step 1. 실행 전 준비"
            
            echo "🟢 진행중이던 빌드 경로 제거"
            rm -rf $HOME/deokive/app || true
            
            echo "🟢 Deploy 디렉토리에서 파일들을 각자 위치로 이동"
            mkdir -p $HOME/deokive/app
            mv $HOME/deokive/tobe/deokive.jar $HOME/deokive/app/deokive.jar
            
            mkdir -p $HOME/deokive/infra
            mv $HOME/deokive/tobe/docker-compose.yml $HOME/deokive/infra/docker-compose.yml
            mv $HOME/deokive/tobe/.env $HOME/deokive/infra/.env
            
            # -------------------------------------- #
            
            echo "💡 Step 2-1. 실행 : Docker"
            echo "🟢 Docker Compose 빌드 시작"
            cd $HOME/deokive/infra
            set -a 
            source .env 
            set +a
            docker compose up -d
            
            echo "🟢 Docker Compose 상태 확인"
            docker compose ps
            
            echo "🟢 DB, Redis Test"
            sleep 5
            # Redis 테스트
            echo "🟢 Redis Ping Test"
            docker exec redis-container redis-cli -a $REDIS_PASSWORD ping
            
            # MySQL 테스트
            echo "🟢 MySQL Ping Test"
            docker exec -e MYSQL_PWD=$DB_PASSWORD mysql-container mysqladmin ping -h localhost -uroot
            
            echo "💡 Step 2-2. 실행 : Spring Boot"
            echo "🟢 Spring Boot 실행"
            echo "🟢 deokive.service 재시작"
            sudo systemctl restart deokive.service
            
            echo "🟢 Spring Boot Health Check (최대 60초 대기)"
            for i in {1..12}; do
              if curl -fs http://localhost:8080/api/system/health > /dev/null; then
                echo "✅ Health check 성공! 배포 완료."
            
                # ✅ (성공 시) 'tobe' 디렉토리 최종 제거
                cd $HOME # infra 디렉토리에서 나옴
                rm -rf $HOME/deokive/tobe
            
                exit 0 # 스크립트 성공 종료
              fi
              echo "($i/12) Spring Boot 시작 대기 중... (5초 후 재시도)"
              sleep 5
            done
            
            echo "❌ Health check 실패. 배포 스크립트를 중단합니다."
            echo "EC2 서버에서 'sudo journalctl -f -u deokive.service' 명령어로 로그를 확인하세요."
            
            # ❌ (실패 시) 'tobe' 디렉토리 최종 제거
            cd $HOME # infra 디렉토리에서 나옴
            rm -rf $HOME/deokive/tobe
            
            exit 1