server:
  tomcat:
    threads:
      max: 120 # 120
      min-spare: 20 # 20


spring:
  jackson:
    time-zone: Asia/Seoul       # 모든 시간대 응답을 KST로 통일
    serialization:
      write-dates-as-timestamps: false

  profiles:
    active: dev # 개발할 때는 dev, 배포할 때는 prod

  batch:
    jdbc:
      initialize-schema: always # 실행 시 BATCH_ 관련 테이블이 없으면 자동 생성
    job:
      enabled: false

  rabbitmq:
    host: ${RABBITMQ_HOST:localhost}          # RabbitMQ 서버 호스트 (로컬 실행 시 localhost, 컨테이너 환경 시 서비스명)
    port: ${RABBITMQ_PORT:5672}     # RabbitMQ 기본 포트 (AMQP 포트)
    username: ${RABBITMQ_USERNAME}  # RabbitMQ 사용자 이름 (기본값: guest)
    password: ${RABBITMQ_PASSWORD}  # RabbitMQ 비밀번호 (기본값: guest)
    virtual-host: /                 # 가상 호스트 (기본값: /)

    # 리스너(Listener) 관련 설정 (선택 사항)
    listener:
      simple:
        acknowledge-mode: auto  # 메시지 수신 확인 모드 (auto, manual, none)
        retry:
          enabled: true         # 메시지 처리 실패 시 재시도 활성화
          initial-interval: 1000ms
          max-attempts: 3
          max-interval: 10000ms
          multiplier: 2.0

  mail:
    host: smtp.gmail.com
    port: 587
    username: ${GMAIL_USERNAME}
    password: ${SMTP_PWD}
    group: ${MAIL_GROUP}
    properties:
      mail:
        smtp:
          debug: true
          auth: true                    # SMTP 인증 사용 여부 (Gmail은 필요함)
          starttls.enable: true         # 일반 연결을 암호화된 연결로 업그레이드 -> Gmail이면 필수
          connectiontimeout: 5000       # SMTP 서버 연결 타임아웃 (Ms)
          timeout: 15000                # SMTP 명령 응답 대기 타임아웃 (Ms)
          writetimeout: 15000           # 이메일 본문 전송 시 대기 시간 (Ms)

  datasource:
    url: jdbc:mysql://${DB_HOST}:${DB_PORT:3306}/${DB_NAME}?rewriteBatchedStatements=true
    driver-class-name: com.mysql.cj.jdbc.Driver
    username: ${DB_USERNAME:root}
    password: ${DB_PASSWORD}
    hikari:
      maximum-pool-size: 6 # t3.small 기준 vCPU * 2 (기존 50)
      minimum-idle: 6       # 고정해두는 게 튀는 부하 방지에 유리
      connection-timeout: 30000 # 30초 대기

  cloud:
    aws:
      s3:
        bucket: ${AWS_S3_BUCKET_NAME}
      region:
        static: ap-northeast-2

  data:
    redis:
      host: ${REDIS_HOST:localhost}
      port: ${REDIS_PORT:6379}
      password: ${REDIS_PASSWORD:}
      lettuce:
        pool:
          max-active: 8 # 48
          max-idle: 8 # 32
          min-idle: 2 # 8
          max-wait: 1000ms # 5000ms

  security:
    oauth2:
      client:
        registration:
          google:
            client-id: ${OAUTH_GOOGLE_CLIENT_ID}
            client-secret: ${OAUTH_GOOGLE_CLIENT_SECRET}
            client-name: Google
            authorization-grant-type: authorization_code
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            scope:
              - email
              - profile
          #              - openid

          naver:
            client-id: ${OAUTH_NAVER_CLIENT_ID}
            client-secret: ${OAUTH_NAVER_CLIENT_SECRET}
            client-name: Naver
            authorization-grant-type: authorization_code
            client-authentication-method: client_secret_post
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            scope:
              - email
              - nickname
            provider: naver

          kakao:
            client-id: ${OAUTH_KAKAO_CLIENT_ID}
            client-secret: ${OAUTH_KAKAO_CLIENT_SECRET}
            client-name: Kakao
            authorization-grant-type: authorization_code
            client-authentication-method: client_secret_post
            redirect-uri: "{baseUrl}/login/oauth2/code/{registrationId}"
            scope:
              - account_email
              - profile_image
              - profile_nickname
            provider: kakao

        provider:
          naver:
            authorization-uri: https://nid.naver.com/oauth2.0/authorize
            token-uri: https://nid.naver.com/oauth2.0/token
            user-info-uri: https://openapi.naver.com/v1/nid/me
            user-name-attribute: response

          kakao:
            authorization-uri: https://kauth.kakao.com/oauth/authorize
            token-uri: https://kauth.kakao.com/oauth/token
            user-info-uri: https://kapi.kakao.com/v2/user/me
            user-name-attribute: id

app:
  cookie:
    secure: false
    cookie-atk: "ATK"
    cookie-rtk: "RTK"
    same-site: "Lax"
    atk-apply-path: "/"
    rtk-apply-path: "/api/v1"  # refresh와 logout 엔드포인트 모두에서 접근 가능하도록 변경

  # Ex: "http://localhost:5173/oauth/callback,https://domain.com/oauth/callback"
  front-redirect-uri: "${FRONT_REDIRECT_URI:http://localhost:5173/oauth/callback}"
  # Ex: "http://localhost:5173,https://domain.com"
  front-base-url: "${FRONT_BASE_URL:http://localhost:5173}"
  allowed-origins: "${ALLOWED_ORIGINS:http://localhost:5173,http://localhost:3000}"



hmac:
  secret: ${HMAC_SECRET_KEY} # at least 32 characters long

cdn:
  base-url: ${CDN_BASE_URL:} # CDN이 있다면 설정, 없으면 빈 문자열 (S3 URL 사용)

scheduler:
  post-hot-score-cron: "5 0 * * * *"      # Post: 매시 정각 05초 (ViewCount와 5초 간격)
  archive-hot-score-cron: "5 30 * * * *"  # Archive: 매시 30분 05초 (Post와 30분 간격)
  badge-cron: "0 0 3 * * *"               # 트래픽이 적은 "새벽 3시 00분"
  file-cleanup-cron: "0 30 4 * * *"       # 매일 새벽 3시에 파일 정리
  file-cleanup:
    threshold-hours: 24                   # 파일 생성 후 삭제 대상이 되기까지의 시간 (시간 단위)
    skip-limit: 10                        # S3 삭제 실패 시 최대 스킵 허용 개수
    retry:
      max-attempts: 3                     # S3 삭제 재시도 최대 횟수
      delay-ms: 1000                      # 재시도 간 지연 시간 (밀리초)

  post-view-cron: "0 */1 * * * *"         # Post: 매 1분 00초
  archive-view-cron: "30 */1 * * * *"     # Archive: 매 1분 30초 (Post와 30초 간격)

  # LikeCount: 분산 실행 (Post는 10초, Archive는 40초)
  post-like-cron: "10 * * * * *"
  archive-like-cron: "40 * * * * *"

  view-cooldown-minutes: 10

ratelimit:
  redis:
    timeout-fail-open: 200ms     # limiter 장애 시 빠르게 통과
    timeout-fail-closed: 500ms   # auth는 차단하되 짧게 실패
  expiration:
    refill-to-max-jitter: 10s
  failure:
    mode: FAIL_OPEN             # 기본은 FAIL_OPEN, auth는 애노테이션 failClosed=true로 닫는다
  key:
    namespace: ratelimit
    user-prefix: user
    ip-prefix: ip
  logging:
    backend-error-min-interval-ms: 1000
  proxy:
    trusted-cidrs: ${TRUSTED_CIDRS} # ex. 172.18.0.0/20,172.39.16.0/20, ...
